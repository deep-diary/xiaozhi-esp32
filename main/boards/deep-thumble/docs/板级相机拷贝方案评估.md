# 板级相机「拷贝并替换」方案评估

## 方案概述

- 将 `main/boards/common/` 下的 **camera.h、esp32_camera.h、esp32_camera.cc** 拷贝到 **板级目录**（如 `main/boards/deep-thumble/`）并在此修改。
- 构建 deep-thumble 时：**不再编译、不引用** common 下的这三者，改为编译并引用板级目录下的副本。
- common 目录保持不动，后续上游更新无需对这三份文件做 merge。

目标能力包括：单采集、单显示、采集+显示、获取最后一帧；后续 Explain 扩展（如「仅云端识别人脸、非大模型解释」等字段）。

---

## 一、可行性（构建与引用）

### 1.1 当前构建与引用关系

- **SOURCES**：通过 `file(GLOB BOARD_COMMON_SOURCES .../boards/common/*.cc)` 把 **esp32_camera.cc** 编进 main。
- **INCLUDE_DIRS**：包含 `.../boards/common`，且该路径在 `.../boards/${BOARD_TYPE}` 之前，因此 `#include "camera.h"` / `#include "esp32_camera.h"` 会先找到 common 下的头文件。
- **deep-thumble 引用**：  
  - `deep_thumble.cc`：`#include "camera.h"`、`#include "esp32_camera.h"`，并 `new Esp32Camera(...)`  
  - app_ai、task_face_camera、face_recognition、task_face_explain：`#include "camera.h"`  
  - `main/mcp_server.cc`：通过 `board.GetCamera()` 拿到 `Camera*`，未直接包含 camera/esp32_camera 头文件。
- **common/board.h**：`#include "camera.h"`，被多处使用；只要保证「camera.h 的解析顺序」在 deep-thumble 构建时优先走板级即可。

因此：**在构建上做到「deep-thumble 用板级副本、common 不动」是可行的**，需要做两件事：  
① 让板级相机头文件优先于 common 被找到；  
② 只编板级 esp32_camera.cc，不编 common 的 esp32_camera.cc。

### 1.2 推荐目录与构建改动

- **板级放置**（二选一，推荐 1）  
  - **方案 A**：`main/boards/deep-thumble/camera/` 下放  
    - `camera.h`  
    - `esp32_camera.h`  
    - `esp32_camera.cc`  
  - **方案 B**：直接放在 `main/boards/deep-thumble/` 根下（与 `deep_thumble.cc` 同级），则头文件可能与现有 deep-thumble 头文件混在一起，不如单独 `camera/` 清晰。

- **CMakeLists.txt 修改（仅当 `BOARD_TYPE == deep-thumble` 时）**  
  在 `main/CMakeLists.txt` 中，在已有 `BOARD_TYPE STREQUAL "deep-thumble"` 的块附近增加：

  1. **排除 common 的 esp32_camera.cc**（仅对 deep-thumble；ESP32 目标已在别处排除 common 的 esp32_camera，若 deep-thumble 是 ESP32S3 等需在此再排除一次）：

     ```cmake
     list(REMOVE_ITEM SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/boards/common/esp32_camera.cc")
     ```

  2. **加入板级 esp32_camera.cc**：

     ```cmake
     list(APPEND SOURCES "${CMAKE_CURRENT_SOURCE_DIR}/boards/deep-thumble/camera/esp32_camera.cc")
     ```

  3. **板级 camera 头路径优先于 common**（保证 `#include "camera.h"` / `#include "esp32_camera.h"` 解析到板级）：

     ```cmake
     list(INSERT INCLUDE_DIRS 0 "${CMAKE_CURRENT_SOURCE_DIR}/boards/deep-thumble/camera")
     ```

- **include 写法**  
  - deep-thumble 内继续使用 `#include "camera.h"`、`#include "esp32_camera.h"` 即可，无需改成相对路径或新文件名。  
  - common/board.h 里的 `#include "camera.h"` 在 deep-thumble 构建时会因上面 3 而解析到板级 camera.h，无需改 common。

- **其他板子**  
  - 不满足 `BOARD_TYPE STREQUAL "deep-thumble"` 时不会执行上述三步，仍使用 common 的 camera/esp32_camera，行为不变。

---

## 二、优点

| 点 | 说明 |
|----|------|
| 不改 common 源码 | common 下 camera/esp32_camera 保持原样，满足「不改动源码」的约束。 |
| 无 merge 负担 | 上游更新 common 时，不需要对这三份文件做 merge；板级副本完全独立演进。 |
| 扩展自由 | 板级可随意增加：CaptureOnly()、ShowLastFrame()、ShowBuffer()、GetLastFrame() 等；Explain 可加参数/字段（如 mode=face_recognition_only），便于云端区分「识别人脸」与「大模型解释」。 |
| 行为清晰 | deep-thumble 的相机行为完全由板级目录定义，和 common 行为解耦。 |
| 与现有调用兼容 | deep_thumble.cc、app_ai、mcp_server 等仍通过 `Camera*` / `Esp32Camera*` 和现有接口调用，只需实现满足接口的板级类即可。 |

---

## 三、缺点与风险

| 点 | 说明 | 缓解 |
|----|------|------|
| 与上游脱节 | common 中相机相关 bug 修复、新格式、新传感器、性能优化不会自动进入板级副本。 | 定期 diff common 与板级，按需手工 port 重要修复或特性。 |
| 双份维护 | 板级副本需自己维护（编译选项、宏、依赖 esp_video/display 等）。 | 在板级文件顶部注释「fork 自 common，板级定制」，并记录与 common 的差异。 |
| 初版工作量 | 拷贝后要改：CaptureOnly、显示分离、Explain 扩展等，改动量可能不少。 | 分阶段：先 1:1 拷贝+构建切到板级，再逐步加方法、改 Explain。 |
| 宏/依赖一致 | esp32_camera 依赖 CONFIG_*、esp_video、lvgl_display 等，板级需保持与当前 deep-thumble 的 sdkconfig/Kconfig 一致。 | 拷贝时保留原有 #ifdef，仅在板级增加新逻辑。 |

---

## 四、与「在 common 上直接改」的对比

| 维度 | 板级拷贝并替换（本方案） | 在 common 上直接改 |
|------|---------------------------|--------------------|
| common 是否改动 | 否 | 是 |
| 上游更新 | 无需 merge 这三份文件 | 可能需 merge |
| 其他板子 | 不受影响，仍用 common | 所有用 common 相机的板子都受影响，需回归 |
| 扩展自由度 | 板级完全自主 | 受 common 接口和兼容性约束 |
| 获得上游修复 | 需手工 port | 随仓库更新自动获得 |

若希望「不改 common、且 deep-thumble 相机逻辑长期独立、Explain 等扩展多」，**板级拷贝并替换是合理选择**；若能接受改 common 且希望所有板子共享同一套相机能力与修复，则选在 common 上改。

---

## 五、实施顺序建议

1. **建目录并拷贝**  
   - 创建 `main/boards/deep-thumble/camera/`，拷贝 common 的 camera.h、esp32_camera.h、esp32_camera.cc 到该目录。

2. **只做构建切换**  
   - 在 main/CMakeLists.txt 中按 1.2 做三处修改（排除 common 的 esp32_camera.cc、加入板级 esp32_camera.cc、板级 camera 头路径插到 INCLUDE_DIRS 前面）。  
   - 编译 deep-thumble，确认行为与当前（用 common）一致，不做逻辑修改。

3. **在板级副本上做功能扩展**  
   - 增加 CaptureOnly()、ShowLastFrame() 等；  
   - 再改 Explain 的语义或参数（如增加「仅云端人脸识别」模式及对应字段）。

4. **文档与维护**  
   - 在板级 camera 目录加 README，说明「fork 自 common，仅 deep-thumble 使用」；  
   - 重要上游修复时，用 diff 对比 common 与板级，按需手工合入。

---

## 六、结论

- **技术上可行**：通过「板级目录 + 构建时排除 common 的 esp32_camera.cc + 板级 camera 头路径优先」即可做到不改 common、仅 deep-thumble 使用板级相机实现。  
- **适合你的目标**：单采集/单显示/采集+显示/获取最后一帧、Explain 扩展（如云端仅识别人脸）都可以在板级副本中实现，且无需对 common 做 merge。  
- **代价**：需接受与上游 common 相机代码脱节，重要修复需手工 port；初版需完成拷贝与构建切换，再逐步加功能。  

若采纳本方案，建议按第五节顺序实施，先保证构建与行为一致，再在板级副本上迭代功能。
