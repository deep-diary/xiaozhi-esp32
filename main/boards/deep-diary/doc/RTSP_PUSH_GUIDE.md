# ESP32-CAM RTSPæ¨æµåˆ°MediaMTXä½¿ç”¨æŒ‡å—

## ğŸ¯ åŠŸèƒ½è¯´æ˜

æœ¬å®ç°æ˜¯**RTSPæ¨æµå®¢æˆ·ç«¯**æ¨¡å¼ï¼ŒESP32ä¸»åŠ¨æ¨é€è§†é¢‘æµåˆ°è¿œç¨‹MediaMTXæœåŠ¡å™¨ï¼ˆ35.192.64.247:8554ï¼‰ã€‚

###ç½‘ç»œæ‹“æ‰‘

```
ESP32-CAM (æœ¬åœ°å†…ç½‘)  â”€â”€æ¨æµâ”€â”€>  MediaMTXæœåŠ¡å™¨ (35.192.64.247)  <â”€â”€æ‹‰æµâ”€â”€ è§‚çœ‹ç«¯
    192.168.x.x                        å…¬ç½‘å¯è®¿é—®                    VLC/Browser
```

**å…³é”®ç‰¹ç‚¹ï¼š**
- âœ… ESP32**ä¸»åŠ¨æ¨æµ**ï¼Œæ— éœ€å…¬ç½‘IP
- âœ… é€‚åˆå†…ç½‘è®¾å¤‡æ¨é€åˆ°å…¬ç½‘æœåŠ¡å™¨
- âœ… MediaMTXä½œä¸ºä¸­è½¬ï¼Œæ”¯æŒå¤šå®¢æˆ·ç«¯è§‚çœ‹
- âœ… æ”¯æŒHLSã€WebRTCç­‰å¤šç§è§‚çœ‹æ–¹å¼

---

## ğŸ“‹ å‰ç½®è¦æ±‚

### 1. MediaMTXæœåŠ¡å™¨ï¼ˆå·²å®Œæˆï¼‰

æ‚¨çš„Dockerå‘½ä»¤å·²ç»æ­£ç¡®é…ç½®ï¼š

```bash
docker run --rm -it \
-e MTX_RTSPTRANSPORTS=tcp \
-e MTX_WEBRTCADDITIONALHOSTS=192.168.x.x \
-p 8554:8554 \
-p 1935:1935 \
-p 8888:8888 \
-p 8889:8889 \
-p 8890:8890/udp \
-p 8189:8189/udp \
bluenviron/mediamtx
```

**ç«¯å£è¯´æ˜ï¼š**
- `8554`: RTSPç«¯å£ï¼ˆESP32æ¨æµåˆ°è¿™é‡Œï¼‰
- `8888`: HLSç«¯å£ï¼ˆæµè§ˆå™¨è§‚çœ‹ï¼‰
- `8889`: WebRTCç«¯å£ï¼ˆä½å»¶è¿Ÿè§‚çœ‹ï¼‰
- `1935`: RTMPç«¯å£ï¼ˆå¤‡ç”¨ï¼‰

### 2. ESP32ç½‘ç»œé…ç½®

ç¡®ä¿ESP32å·²è¿æ¥WiFiå¹¶èƒ½è®¿é—®å…¬ç½‘ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤1ï¼šç¼–è¯‘çƒ§å½•

```bash
cd /Users/hanli/Desktop/DeepDiary/DeepController

# ç¼–è¯‘
idf.py build

# çƒ§å½•
idf.py flash monitor
```

### æ­¥éª¤2ï¼šç­‰å¾…åˆå§‹åŒ–

æŸ¥çœ‹ä¸²å£æ—¥å¿—ï¼Œç¡®è®¤ï¼š
```
I (5000) atk_dnesp32s3: ç›¸æœºåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ
I (5100) wifi_station: WiFi connected, IP: 192.168.x.x
I (5200) atk_dnesp32s3: RTSPæ§åˆ¶åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ
```

### æ­¥éª¤3ï¼šå¯åŠ¨æ¨æµ

#### æ–¹å¼Aï¼šé€šè¿‡MCPå·¥å…·ï¼ˆæ¨èï¼‰

```json
{
  "tool": "rtsp_start",
  "arguments": {
    "fps": 10
  }
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "success": true,
  "message": "RTSPæ¨æµå¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨",
  "server": "rtsp://35.192.64.247:8554/esp32cam",
  "view_url": "rtsp://35.192.64.247:8554/esp32cam"
}
```

#### æ–¹å¼Bï¼šåœ¨ä»£ç ä¸­è‡ªåŠ¨å¯åŠ¨

ä¿®æ”¹ `InitializeRtspControl()` æœ«å°¾ï¼š

```cpp
// è‡ªåŠ¨å¯åŠ¨æ¨æµ
if (rtsp_stream_->Start()) {
    ESP_LOGI(TAG, "RTSPæ¨æµè‡ªåŠ¨å¯åŠ¨");
}
```

### æ­¥éª¤4ï¼šè§‚çœ‹è§†é¢‘æµ

#### æ–¹æ³•1ï¼šVLCæ’­æ”¾å™¨

```
æ‰“å¼€VLC â†’ åª’ä½“ â†’ æ‰“å¼€ç½‘ç»œä¸²æµ
è¾“å…¥: rtsp://35.192.64.247:8554/esp32cam
ç‚¹å‡»æ’­æ”¾
```

#### æ–¹æ³•2ï¼šffplayå‘½ä»¤è¡Œ

```bash
ffplay -rtsp_transport tcp rtsp://35.192.64.247:8554/esp32cam
```

#### æ–¹æ³•3ï¼šæµè§ˆå™¨è§‚çœ‹ï¼ˆHLSï¼‰

```
http://35.192.64.247:8888/esp32cam
```

#### æ–¹æ³•4ï¼šä½å»¶è¿ŸWebRTC

```
http://35.192.64.247:8889/esp32cam
```

---

## ğŸ”§ MCPå·¥å…·ä½¿ç”¨

### 1. rtsp_start - å¯åŠ¨æ¨æµ

**æè¿°**ï¼šå¯åŠ¨RTSPæ¨æµåˆ°è¿œç¨‹æœåŠ¡å™¨

**å‚æ•°**ï¼š
```json
{
  "fps": 10  // å¯é€‰ï¼Œå¸§ç‡ï¼ˆ1-30ï¼‰
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "RTSPæ¨æµå¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨æ¨é€åˆ°è¿œç¨‹æœåŠ¡å™¨",
  "server": "rtsp://35.192.64.247:8554/esp32cam",
  "view_url": "rtsp://35.192.64.247:8554/esp32cam"
}
```

**ä¸²å£æ—¥å¿—**ï¼š
```
I (10000) RtspPusher: è§£æURL - æœåŠ¡å™¨: 35.192.64.247, ç«¯å£: 8554, è·¯å¾„: /esp32cam
I (10100) RtspPusher: æ­£åœ¨è¿æ¥åˆ° 35.192.64.247:8554...
I (10200) RtspPusher: RTSPè¿æ¥å»ºç«‹æˆåŠŸ
I (10300) RtspPusher: RTPç«¯å£åˆ†é…: 5000-5001
I (10400) RtspPusher: å‘é€ANNOUNCEè¯·æ±‚...
I (10500) RtspPusher: ANNOUNCEæˆåŠŸ
I (10600) RtspPusher: å‘é€SETUPè¯·æ±‚...
I (10700) RtspPusher: SETUPæˆåŠŸ
I (10800) RtspPusher: å‘é€RECORDè¯·æ±‚...
I (10900) RtspPusher: RECORDæˆåŠŸï¼Œå¼€å§‹æ¨æµ
I (11000) RtspStream: RTSPæ¨æµå¯åŠ¨æˆåŠŸ
```

### 2. rtsp_stop - åœæ­¢æ¨æµ

**å‚æ•°**ï¼šæ— 

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "RTSPæ¨æµå·²åœæ­¢"
}
```

### 3. rtsp_status - æŸ¥è¯¢çŠ¶æ€

**å‚æ•°**ï¼šæ— 

**å“åº”**ï¼š
```json
{
  "success": true,
  "running": true,
  "connected": true,
  "server": "rtsp://35.192.64.247:8554/esp32cam",
  "view_url": "rtsp://35.192.64.247:8554/esp32cam"
}
```

- `running`: æ¨æµä»»åŠ¡æ˜¯å¦è¿è¡Œ
- `connected`: æ˜¯å¦å·²è¿æ¥åˆ°æœåŠ¡å™¨

### 4. rtsp_set_fps - è®¾ç½®å¸§ç‡

**å‚æ•°**ï¼š
```json
{
  "fps": 15  // 1-30
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "message": "å¸§ç‡å·²è®¾ç½®ä¸º 15 fps"
}
```

---

## ğŸ“Š RTSPæ¨æµåè®®æµç¨‹

```
ESP32                              MediaMTX (35.192.64.247:8554)
  |                                              |
  |--- TCPè¿æ¥ --------------------------------->|
  |                                              |
  |--- ANNOUNCE (å‘é€SDPåª’ä½“æè¿°) -------------->|
  |<-- 200 OK -----------------------------------|
  |                                              |
  |--- SETUP (å»ºç«‹RTPä¼ è¾“é€šé“) ----------------->|
  |<-- 200 OK (è¿”å›æœåŠ¡å™¨RTPç«¯å£) ---------------|
  |                                              |
  |--- RECORD (å¼€å§‹æ¨æµ) ----------------------->|
  |<-- 200 OK -----------------------------------|
  |                                              |
  |=== RTP JPEGæ•°æ®åŒ… (UDP) ====================>|
  |=== è¿ç»­æ¨é€è§†é¢‘å¸§ ============================>|
  |                                              |
  |--- TEARDOWN (ç»“æŸ) ------------------------->|
  |<-- 200 OK -----------------------------------|
  |                                              |
```

**åè®®ç»†èŠ‚ï¼š**

1. **ANNOUNCE** - å‘Šè¯‰æœåŠ¡å™¨æˆ‘è¦æ¨é€ä»€ä¹ˆç±»å‹çš„æµ
   ```
   ANNOUNCE rtsp://35.192.64.247:8554/esp32cam RTSP/1.0
   Content-Type: application/sdp
   
   v=0
   m=video 0 RTP/AVP 26
   a=rtpmap:26 JPEG/90000
   ```

2. **SETUP** - åå•†RTPä¼ è¾“å‚æ•°
   ```
   SETUP rtsp://35.192.64.247:8554/esp32cam/track0 RTSP/1.0
   Transport: RTP/AVP;unicast;client_port=5000-5001
   
   Response:
   Transport: RTP/AVP;unicast;server_port=6000-6001
   ```

3. **RECORD** - å¼€å§‹æ¨æµ
   ```
   RECORD rtsp://35.192.64.247:8554/esp32cam RTSP/1.0
   Range: npt=0.000-
   ```

4. **RTPæ•°æ®ä¼ è¾“** - UDPæ¨é€JPEGå¸§
   - æ¯å¸§JPEGæ‹†åˆ†æˆå¤šä¸ªRTPåŒ…ï¼ˆMTU 1400å­—èŠ‚ï¼‰
   - åºåˆ—å·é€’å¢ï¼Œæ—¶é—´æˆ³æŒ‰90kHzæ—¶é’Ÿé€’å¢

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šè¿æ¥æœåŠ¡å™¨å¤±è´¥

**æ—¥å¿—ç¤ºä¾‹ï¼š**
```
E (10000) RtspPusher: è¿æ¥åˆ°æœåŠ¡å™¨å¤±è´¥: 113
```

**å¯èƒ½åŸå› ï¼š**
1. æœåŠ¡å™¨æœªå¯åŠ¨æˆ–IPé”™è¯¯
2. é˜²ç«å¢™é˜»æ­¢
3. ç½‘ç»œä¸é€š

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# åœ¨ESP32æ‰€åœ¨ç½‘ç»œæµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§
ping 35.192.64.247

# æµ‹è¯•RTSPç«¯å£
nc -zv 35.192.64.247 8554

# æ£€æŸ¥MediaMTXæ˜¯å¦è¿è¡Œ
docker ps | grep mediamtx
```

### é—®é¢˜2ï¼šANNOUNCEå¤±è´¥ï¼ˆçŠ¶æ€ç 403/404ï¼‰

**æ—¥å¿—ç¤ºä¾‹ï¼š**
```
E (10500) RtspPusher: ANNOUNCEå¤±è´¥ï¼ŒçŠ¶æ€ç : 403
```

**å¯èƒ½åŸå› ï¼š**
- MediaMTXé…ç½®äº†æ¨æµè®¤è¯
- è·¯å¾„ä¸å­˜åœ¨æˆ–ä¸å…è®¸æ¨é€

**è§£å†³æ–¹æ¡ˆï¼š**

æ£€æŸ¥MediaMTXé…ç½®ï¼Œç¡®ä¿å…è®¸æ¨æµï¼š

```yaml
# MediaMTXé»˜è®¤å…è®¸æ¨æµåˆ°ä»»æ„è·¯å¾„
# å¦‚æœæœ‰é™åˆ¶ï¼Œéœ€è¦æ·»åŠ ï¼š
paths:
  esp32cam:
    # å…è®¸ä»»ä½•äººæ¨é€
    publishUser: ""
    publishPass: ""
```

### é—®é¢˜3ï¼šè§†é¢‘æœ‰ä½†å¾ˆå¡

**å¯èƒ½åŸå› ï¼š**
- ç½‘ç»œå¸¦å®½ä¸è¶³
- å¸§ç‡è¿‡é«˜
- JPEGè´¨é‡è¿‡é«˜

**è§£å†³æ–¹æ¡ˆï¼š**
```json
// é™ä½å¸§ç‡
{"tool": "rtsp_set_fps", "arguments": {"fps": 5}}
```

æˆ–åœ¨ä»£ç ä¸­ï¼š
```cpp
rtsp_stream_->SetFrameRate(5);
rtsp_stream_->SetJpegQuality(60);
```

### é—®é¢˜4ï¼šè¿æ¥æˆåŠŸä½†æ— ç”»é¢

**æ£€æŸ¥æ¸…å•ï¼š**

1. **ç›¸æœºæ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ**
   ```
   I (5000) atk_dnesp32s3: ç›¸æœºåŠŸèƒ½åˆå§‹åŒ–å®Œæˆ
   ```

2. **é‡‡é›†ä»»åŠ¡æ˜¯å¦è¿è¡Œï¼Ÿ**
   ```
   I (10000) RtspStream: é‡‡é›†ä»»åŠ¡å¯åŠ¨
   ```

3. **æ˜¯å¦æ­£åœ¨æ¨é€å¸§ï¼Ÿ**
   ```
   D (11000) RtspStream: æ¨é€å¸§å¤±è´¥  // å¦‚æœçœ‹åˆ°è¿™ä¸ªï¼Œè¯´æ˜æœ‰é—®é¢˜
   ```

4. **MediaMTXæ˜¯å¦æ”¶åˆ°æµï¼Ÿ**
   - æ£€æŸ¥MediaMTXæ—¥å¿—ï¼š`docker logs <container_id>`
   - åº”è¯¥çœ‹åˆ°ï¼š`[RTSP] [conn] opened`

### é—®é¢˜5ï¼šç¼–è¯‘é”™è¯¯

**é”™è¯¯ç¤ºä¾‹ï¼š**
```
undefined reference to `RtspPusher::Connect()'
```

**è§£å†³ï¼š**
```bash
idf.py fullclean
idf.py build
```

CMakeLists.txtä¼šè‡ªåŠ¨åŒ…å« `boards/atk-dnesp32s3/*.cc` æ–‡ä»¶ã€‚

---

## âš™ï¸ é«˜çº§é…ç½®

### ä¿®æ”¹æœåŠ¡å™¨åœ°å€

åœ¨ `atk_dnesp32s3.cc` çš„ `InitializeRtspControl()` å‡½æ•°ä¸­ä¿®æ”¹ï¼š

```cpp
// ä¿®æ”¹ä¸ºæ‚¨çš„æœåŠ¡å™¨åœ°å€
rtsp_stream_ = std::make_unique<RtspStream>(
    camera_, 
    "rtsp://YOUR_SERVER_IP:8554/YOUR_PATH"
);
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### ä½å¸¦å®½ç½‘ç»œï¼ˆæ¨èé…ç½®ï¼‰
```cpp
rtsp_stream_->SetFrameRate(5);      // 5fps
rtsp_stream_->SetJpegQuality(60);   // è´¨é‡60
// å¸¦å®½éœ€æ±‚ï¼š~150 KB/s
```

#### å¹³è¡¡æ¨¡å¼
```cpp
rtsp_stream_->SetFrameRate(10);     // 10fps
rtsp_stream_->SetJpegQuality(80);   // è´¨é‡80
// å¸¦å®½éœ€æ±‚ï¼š~400 KB/s
```

#### é«˜è´¨é‡æ¨¡å¼
```cpp
rtsp_stream_->SetFrameRate(15);     // 15fps
rtsp_stream_->SetJpegQuality(90);   // è´¨é‡90
// å¸¦å®½éœ€æ±‚ï¼š~800 KB/s
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

| æ¨¡å¼ | å¸§ç‡ | JPEGè´¨é‡ | å¸¦å®½ | å»¶è¿Ÿ | CPU | é€‚ç”¨åœºæ™¯ |
|------|------|----------|------|------|-----|----------|
| ä½å¸¦å®½ | 5fps | 60 | 150KB/s | ~500ms | 15% | ç›‘æ§ |
| æ¨è | 10fps | 80 | 400KB/s | ~400ms | 25% | é€šç”¨ |
| é«˜è´¨é‡ | 15fps | 85 | 600KB/s | ~350ms | 35% | å®æ—¶é¢„è§ˆ |

**å»¶è¿Ÿç»„æˆï¼š**
- é‡‡é›†+ç¼–ç : 50-80ms
- ç½‘ç»œä¼ è¾“: 50-150msï¼ˆå–å†³äºç½‘ç»œï¼‰
- MediaMTXè½¬å‘: 10-20ms
- å®¢æˆ·ç«¯è§£ç +æ’­æ”¾: 100-200ms
- **æ€»è®¡ï¼š200-450ms**

---

## ğŸ” å®‰å…¨å»ºè®®

### 1. æ·»åŠ æ¨æµè®¤è¯

åœ¨MediaMTXä¸­é…ç½®ï¼š

```yaml
paths:
  esp32cam:
    publishUser: "esp32"
    publishPass: "your_password_here"
```

åœ¨ESP32ä»£ç ä¸­æ·»åŠ è®¤è¯ï¼ˆéœ€è¦ä¿®æ”¹ `rtsp_pusher.cc`ï¼‰ï¼š

```cpp
// åœ¨ANNOUNCEè¯·æ±‚ä¸­æ·»åŠ Authorizationå¤´éƒ¨
std::string auth = "Authorization: Basic " + base64_encode("esp32:your_password_here");
SendRtspRequest("ANNOUNCE", auth, sdp);
```

### 2. ä½¿ç”¨HTTPSï¼ˆæœªæ¥æ”¯æŒï¼‰

MediaMTXæ”¯æŒRTSPSï¼ˆRTSP over TLSï¼‰ï¼Œä½†éœ€è¦è¯ä¹¦é…ç½®ã€‚

---

## ğŸ“ è°ƒè¯•æŠ€å·§

### å¯ç”¨è¯¦ç»†æ—¥å¿—

åœ¨ `rtsp_pusher.cc` å’Œ `rtsp_stream.cc` ä¸­ï¼š

```cpp
esp_log_level_set("RtspPusher", ESP_LOG_DEBUG);
esp_log_level_set("RtspStream", ESP_LOG_DEBUG);
```

### ä½¿ç”¨WiresharkæŠ“åŒ…

```bash
# åœ¨æœåŠ¡å™¨ä¸ŠæŠ“åŒ…
sudo tcpdump -i eth0 port 8554 -w rtsp.pcap

# åˆ†æ
wireshark rtsp.pcap
```

### æŸ¥çœ‹MediaMTXæ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹
docker logs -f <container_id>

# æœç´¢ç‰¹å®šä¿¡æ¯
docker logs <container_id> | grep "esp32cam"
```

---

## âœ… æµ‹è¯•æ¸…å•

- [ ] ESP32æˆåŠŸè¿æ¥WiFi
- [ ] ç›¸æœºåˆå§‹åŒ–æˆåŠŸ
- [ ] RTSPæ¨æµå¯åŠ¨æˆåŠŸ
- [ ] MediaMTXæ”¶åˆ°è¿æ¥
- [ ] VLCèƒ½å¤Ÿæ’­æ”¾
- [ ] ç”»é¢æµç•…æ— å¡é¡¿
- [ ] å»¶è¿Ÿåœ¨å¯æ¥å—èŒƒå›´
- [ ] é•¿æ—¶é—´è¿è¡Œç¨³å®š

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **RFC 2326**: RTSP 1.0åè®®
- **RFC 2435**: RTP JPEGæ ¼å¼
- **MediaMTXæ–‡æ¡£**: https://github.com/bluenviron/mediamtx
- **ESP32-Cameraåº“**: https://github.com/espressif/esp32-camera

---

**ç‰ˆæœ¬**: 2.0.0 (æ¨æµæ¨¡å¼)  
**æœ€åæ›´æ–°**: 2025-10-19  
**é€‚ç”¨äº**: MediaMTX Dockeréƒ¨ç½²

